#!/usr/bin/env bash

# Un-break the 8 client AP limit on some RPi boards by activating "minimal" broadcom firmware, 
# bumping the new limit up to 20.
#
# Author: Anton Slavin
# Create date: 2024-01-25

[ "$IOTEMPOWER_ACTIVE" = "yes" ] || { echo "IoTempower not active, aborting." 1>&2;exit 1; }


# First gather some version information
raspberry_pi_version=$(cat /proc/cpuinfo | grep Model | awk -F ': ' '{print $2}')

# Check if the version matches 3A+, 4, or 5
if [[ "$raspberry_pi_version" =~ "Raspberry Pi 3 Model A+" || "$raspberry_pi_version" =~ "Raspberry Pi 4" || "$raspberry_pi_version" =~ "Raspberry Pi Zero 2 W" ]]; then
    echo "This Raspberry Pi board is supported, going on..."
else
    echo "This Raspberry Pi board is not supported! Abandoning operation"
    exit
fi

minimal_firmware_path="/lib/firmware/cypress/cyfmac43455-sdio-minimal.bin"
default_firmware_path="/lib/firmware/brcm/brcmfmac43455-sdio.bin"

if [ -e "$minimal_firmware_path" ]; then
    echo "Minimal firmware file found, going on..."
else
    echo "No correct version of minimal firmware found! Abandoning operation"
    exit
fi

# Now check some paths to see if we have the right firmware in use right now
# ...

# Minimal firmware is already activated, exit
# ...


# Everything OK and we can activate the minimal firmware by setting up a syslink to it
# ...
echo "Replacing default firmware file with the minimal version. NB! sudo access is required for the following operation!

sudo ln -sf $minimal_firmware_path $default_firmware_path


# Finally, need a reboot to finalize things
echo "A reboot of your device is required to active the new minimal firmware version"
# ...
