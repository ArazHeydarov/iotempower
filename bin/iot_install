#!/usr/bin/env bash

# if not available, install all dependencies
# and also allow to fix shebangs in local bin folder
#
# check if everything from IOTEMPOWER_EXTERNAL is downloaded and accessable
# if not asks to install it
#
# if called as check_install clean, it will delete content of IOTEMPOWER_EXTERNAL and
# re-download everything
#
# Author: ulno
# Create date: 2017-05-17

[ "$IOTEMPOWER_ACTIVE" = "yes" ] || { echo "IoTempower not active, aborting." 1>&2;exit 1; }
echo "Installing"
echo "$@"

function welcome() {
cat << EOF
IoTempower installer
====================

Welcome to the IoTempower environment installer. You are just a couple of steps
from setting up a very simple and accessible system to deploy your own
Internet of Things (IoT).

You need build-essential, virtualenv, git, hostapd, dnsmasq, iptables,
bridge-utils, python-dev, mosquitto-clients, haveged,
and a current nodejs installed.

On Ubuntu or Debian systems install these with:
sudo apt install build-essential git mosquitto-clients \n
         virtualenv iptables bridge-utils hostapd dnsmasq haveged \
         python3-dev

Installing a current nodejs on debian, ubuntu, and raspberry os
is not trivial, best follow the instructions for the node install here:
https://github.com/nodesource/distributions/blob/master/README.md


Optionally you want the mqtt server mosquitto, midnight commander (mc),
the editor micro, and the fast simple webserver caddy.
You can install these with:
sudo apt install mc mosquitto micro caddy

Do you want to set it up? (Y/n)
EOF
}

function install_package_if_missing(){
  if [[ $(which "$1") == "" ]]; then
    echo "$1 has not been found in your system, installing. Please wait..."
    apt-get install -y -q "$1"
    echo "$1 has been installed successfully"
  fi
}


if [[ "$1" == clean ]]; then
  echo "Deleting external cache."
  echo
  rm -rf "$IOTEMPOWER_VPYTHON"
  rm -rf "$IOTEMPOWER_EXTERNAL"
fi

# check if virtualenv is configured
if [[ -e "$IOTEMPOWER_VPYTHON/bin/activate" ]]; then # check for existing venv
    source "$IOTEMPOWER_VPYTHON/bin/activate"
else
	if [[ "$1" == *quiet* ]]; then

		answer=y
		answer_commander=y
		answer_node_red=y
		answer_caddy=y
		answer_mqtt=y
		answer_un_break=y
	else
	    welcome
    	read -r answer
    	optional_message="Do you want to install optional dependency"

      echo "${optional_message} CLOUD COMMANDER (Details -> https://cloudcmd.io/)? (Y/n)"
      read -r answer_commander

      echo "${optional_message} NODE-RED (Details -> https://nodered.org/)? (Y/n)"
      read -r answer_node_red

      echo "${optional_message} CADDY (Details -> https://caddyserver.com/)? (Y/n)"
      read -r answer_caddy

      echo "${optional_message} MOSQUITTO (MQTT broker) (Details -> https://mosquitto.org/)? (Y/n)"
      read -r answer_mqtt

      # activate minimal firmware
      echo "In order to support a larger amount of connected devices, a special minimal version
            of the wireless chip firmware has to be enabled.
            NB! A maximum of 8 connected clients are supported without the use of minimal broadcom firmware.
            Do you want to proceed? (Y/n)"
      read -r answer_un_break

    fi
    if [[ "$answer" == "y" ||  "$answer" == "Y" || "$answer" == "" ]]; then
      install_package_if_missing "python3.11-venv"
      install_package_if_missing "git"
      install_package_if_missing "python3-dev"
      install_package_if_missing "gcc-aarch64-linux-gnu"
      install_package_if_missing "make"
      install_package_if_missing "apt-utils"
      install_package_if_missing "jq"
    else
        echo "Can't continue, exiting now."
        exit 1
    fi
    # python2 seems not to be necessary anymore
    # # TODO: recheck, installation seems to fail first time -> path problems (wrong pip used?)
    # # install virtualenv for python2 for platformio
    # mkdir -p "$IOTEMPOWER_VPYTHON2"
    # virtualenv -p "$(which python2)" "$IOTEMPOWER_VPYTHON2"
    # source "$IOTEMPOWER_VPYTHON2/bin/activate"
    # pip install --upgrade pip
    #    pip install --upgrade platformio
    # TODO: go back to normal install, but for now we need version4 (development version)
    # pip install --upgrade https://github.com/platformio/platformio-core/archive/develop.zip
    # deactivate # disable python 2 environment

    # install virtualenv
    python3 -m venv "$IOTEMPOWER_VPYTHON"
    source "$IOTEMPOWER_VPYTHON/bin/activate"
    pip install --no-cache-dir --upgrade pip
    # dependencies
    pip install --no-cache-dir -r "$IOTEMPOWER_ROOT/bin/requirements.txt"

    # access point
    git clone https://github.com/ulno/create_ap "$IOTEMPOWER_EXTERNAL/create_ap"
    #cd "$IOTEMPOWER_EXTERNAL/create_ap"

    # install node.js
    cd "$IOTEMPOWER_LOCAL" || exit
    mkdir nodejs && cd nodejs || exit
    install_package_if_missing "curl"
    curl -fsSL https://deb.nodesource.com/setup_21.x | bash - && apt-get install -y nodejs

    # install node.js related stuff
    npm install -g terminal-kit

    echo "All necessary packages have been installed the rest is optional packages."

    if [[ "$answer_commander" == "y" ||  "$answer_commander" == "Y" ]]; then
      apt install g++ -y
      npm install -g gritty
      npm install -g cloudcmd
      cloudcmd --terminal --terminal-path "$(gritty --path)" --save --no-server
    fi

    if [[ "$answer_node_red" == "y" ||  "$answer_node_red" == "Y" ]]; then
      npm install -g --unsafe-perm node-red
    fi

    if [[ "$answer_caddy" == "y" ||  "$answer_caddy" == "Y" ]]; then
      apt install -y debian-keyring debian-archive-keyring apt-transport-https
      curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/gpg.key' | gpg --dearmor -o /usr/share/keyrings/caddy-stable-archive-keyring.gpg
      curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/debian.deb.txt' | tee /etc/apt/sources.list.d/caddy-stable.list
      apt update
      apt install caddy
    fi

    if [[ "$answer_mqtt" == "y" ||  "$answer_mqtt" == "Y" ]]; then
      apt install mosquitto-clients -y
      apt install mosquitto -y
    fi

    if [[ "$answer_un_break" == "y" ||  "$answer_un_break" == "Y" ]]; then
      echo "Unbreak entered"
      unbreak_ap_limit
    fi

    bash "$IOTEMPOWER_ROOT/bin/fix_bin"

    update_cache

    iot doc make
    # Save the state
    python3 "$IOTEMPOWER_ROOT"/utils/save_arguments_as_json.py --splitter '=' --path "$IOTEMPOWER_LOCAL"/installation_options.json \
    general="$answer" cloud_commander="$answer_commander" \
     node_red="$answer_node_red" caddy="$answer_caddy" \
     mosquitto="$answer_mqtt" answer_un_break="$answer_un_break"

    # Testing the installation
    if ! pytest "$IOTEMPOWER_ROOT"/tests/test_installations.py;
    then
     exit 1
    fi
fi

exit 0